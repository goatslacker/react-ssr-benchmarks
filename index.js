const assert = require('assert')
const Benchmark = require('benchmark')
const SimpleExample = require('./examples/simple')

const Reacts = {
  12: require('./react/12'),
  13: require('./react/13'),
  14: require('./react/14'),
  15: require('./react/15'),
}

function assertVersions(version) {
  const valid = {
    12: '0.12.2',
    13: '0.13.3',
    14: '0.14.8',
    15: '15.3.0',
  }
  const React = Reacts[version].React

  assert.ok(
    React.version === valid[version],
    `Failed version check for ${version}. Expected ${valid[version]} got ${React.version}`)
}

function outputMarkup(name, res) {
  // Prior to starting the test run it'll output the markup to console
  // so you can verify the markup
  console.log(`Markup generated by ${name}:`)
  console.log('`')
  console.log(res)
  console.log('`')
  console.log()
  console.log('Benchmark Results:')
}

// Make sure each version is correct
Object.keys(Reacts).forEach(version => assertVersions(version))

module.exports = (config) => {
  const options = Object.assign({
    // Default getComponent and render implementations just run a "Hello World" test
    getComponent: SimpleExample.getComponent,
    props: SimpleExample.props,
    // Array of custom tests to add to the suite to benchmark vs React
    tests: [],
    // What versions we run benchmarks on
    versions: {
      12: true,
      13: true,
      14: true,
      15: true,
    },
  }, config)

  const suite = new Benchmark.Suite()

  // Enable each react version
  Object.keys(options.versions).forEach((version) => {
    const React = Reacts[version].React
    const ReactDOMServer = Reacts[version].ReactDOMServer
    const Component = options.getComponent(React)
    const Element = React.createElement(Component, options.props)

    const name = `React v${React.version}`

    suite.add(name, function () {
      ReactDOMServer.renderToString(Element)
    })

    outputMarkup(name, ReactDOMServer.renderToString(Element))
  })

  // Add your own tests
  // It'll use the React version you pass in through options as React and ReactDOMServer
  // and it'll get the component just like the other tests to ensure it uses the same component
  options.tests.forEach((test) => {
    const React = test.React
    const ReactDOMServer = test.ReactDOMServer
    const Component = options.getComponent(React)
    const Element = React.createElement(Component, options.props)

    suite.add(test.name, function () {
      ReactDOMServer.renderToString(Element)
    })

    outputMarkup(test.name, ReactDOMServer.renderToString(Element))
  })

  // Run
  suite.on('cycle', function (event) {
    console.log(String(event.target))
  }).on('complete', function () {
    console.log()
    console.log(`Fastest is ${this.filter('fastest').map('name')}`)
  }).run()
}
